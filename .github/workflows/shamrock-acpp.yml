name: Shamrock (AdaptiveCpp)

on:
  workflow_call:


jobs:
  shamrock_acpp_omp_debug_coverage:
    name: AdaptiveCpp coverage omp clang-${{ matrix.clang }}
    runs-on: [self-hosted, ubuntu20]

    strategy:
      matrix:
        clang: [15]
        cuda: [11.0.2]
        rocm: [5.4.3]

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: ls local
        run : ls -la

      - name: configure Shamrock
        run: |
          python3 buildbot/configure.py --gen ninja --tests --build coverage \
            --builddir acpp_omp_debug --cxxpath AdaptiveCpp_comp --compiler acpp --profile omp

      - name: compile Shamrock
        run: |
          cd acpp_omp_debug
          ninja

      - name: run Shamrock Unittests world_size = 1
        run: |
          cd acpp_omp_debug
          LLVM_PROFILE_FILE="utests_0_0.profraw" ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest

      - name: run Shamrock Unittests world_size = 2
        run: |
          cd acpp_omp_debug
          mpirun \
            -n 1 -x LLVM_PROFILE_FILE=utests_2_0.profraw ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest : \
            -n 1 -x LLVM_PROFILE_FILE=utests_2_1.profraw ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
      
      - name: run Shamrock Unittests world_size = 3
        run: |
          cd acpp_omp_debug
          mpirun --oversubscribe \
            -n 1 -x LLVM_PROFILE_FILE=utests_3_0.profraw ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest : \
            -n 1 -x LLVM_PROFILE_FILE=utests_3_1.profraw ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest : \
            -n 1 -x LLVM_PROFILE_FILE=utests_3_2.profraw ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest

      - name: run Shamrock Unittests world_size = 4
        run: |
          cd acpp_omp_debug
          mpirun --oversubscribe \
            -n 1 -x LLVM_PROFILE_FILE=utests_4_0.profraw ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest : \
            -n 1 -x LLVM_PROFILE_FILE=utests_4_1.profraw ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest : \
            -n 1 -x LLVM_PROFILE_FILE=utests_4_2.profraw ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest : \
            -n 1 -x LLVM_PROFILE_FILE=utests_4_3.profraw ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest

      - name: merge coverage reports
        run: |
          cd acpp_omp_debug
          llvm-profdata-15 merge -sparse utests_* -o utests.profdata

      - name: make coverage reports
        run: |
          cd acpp_omp_debug
          llvm-cov-15 report shamrock_test -instr-profile=utests.profdata \
              -ignore-filename-regex=".*external/|.*src/tests/|.*src/shamtest/|.*\main_test.cpp|.*\main.cpp|.*\aliases.hpp"\
               > coverage_list.txt
          llvm-cov-15 show shamrock_test -instr-profile=utests.profdata -format=html -output-dir=out_cov\
              -Xdemangler c++filt -Xdemangler -n \
              -ignore-filename-regex=".*external/|.*src/tests/|.*src/shamtest/|.*\main_test.cpp|.*\main.cpp|.*\aliases.hpp"
      
      - name: print coverage
        run: |
          cd acpp_omp_debug
          llvm-cov-15 report shamrock_test -instr-profile=utests.profdata \
              -ignore-filename-regex=".*external/|.*src/tests/|.*src/shamtest/|.*\main_test.cpp|.*\main.cpp|.*\aliases.hpp"\

      - name: Archive code coverage results 1
        uses: actions/upload-artifact@v3
        with:
          name: code-coverage-list-acpp_omp_debug
          path: acpp_omp_debug/coverage_list.txt

      - name: Archive code coverage results 2
        uses: actions/upload-artifact@v3
        with:
          name: code-coverage-report-acpp_omp_debug
          path: acpp_omp_debug/out_cov/


  shamrock_acpp_omp:
    name: AdaptiveCpp omp clang-${{ matrix.clang }}
    runs-on: [self-hosted, ubuntu20]

    strategy:
      matrix:
        clang: [15,16]
        cuda: [11.0.2]
        rocm: [5.4.3]
    #if: false
  
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
  
      - name: ls local
        run : ls -la
  
      - name: configure Shamrock
        run: |
          python3 buildbot/configure.py --gen ninja --tests --build release \
            --builddir build --cxxpath AdaptiveCpp_comp --compiler acpp --profile omp
  
      - name: compile Shamrock
        run: |
          cd build
          ninja
  
      - name: run Shamrock Unittests world_size = 1
        run: |
          cd build
          ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 2
        run: |
          cd build
          mpirun -n 2 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
      
      - name: run Shamrock Unittests world_size = 3
        run: |
          cd build
          mpirun --oversubscribe -n 3 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 4
        run: |
          cd build
          mpirun --oversubscribe -n 4 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest





  shamrock_acpp_omp_asan:
    name: AdaptiveCpp omp asan clang-${{ matrix.clang }}
    runs-on: [self-hosted, ubuntu20]

    strategy:
      matrix:
        clang: [15,16]
        cuda: [11.0.2]
        rocm: [5.4.3]
    #if: false
  
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
  
      - name: ls local
        run : ls -la

      - name: configure Shamrock
        run: |
          python3 buildbot/configure.py --gen ninja --tests --build debug \
            --builddir build --cxxpath AdaptiveCpp_comp --compiler acpp --profile omp_sanitizer
  
      - name: compile Shamrock
        run: |
          cd build
          ninja
  
      - name: run Shamrock Unittests world_size = 1
        run: |
          cd build
          ASAN_OPTIONS=detect_leaks=0 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 2
        run: |
          cd build
          ASAN_OPTIONS=detect_leaks=0 mpirun -n 2 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
      
      - name: run Shamrock Unittests world_size = 3
        run: |
          cd build
          ASAN_OPTIONS=detect_leaks=0 mpirun --oversubscribe -n 3 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 4
        run: |
          cd build
          ASAN_OPTIONS=detect_leaks=0 mpirun --oversubscribe -n 4 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest





  shamrock_acpp_SSCP:
    name: AdaptiveCpp sscp clang-${{ matrix.clang }}

    runs-on: [self-hosted, ubuntu20]

    strategy:
      matrix:
        clang: [15,16]
        cuda: [11.0.2]
        rocm: [5.4.3]
    #if: false
  
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
  
      - name: ls local
        run : ls -la
  
      - name: configure Shamrock
        run: |

          python3 buildbot/configure.py --gen ninja --tests --build release \
            --builddir build --cxxpath AdaptiveCpp_comp --compiler acpp --profile generic
  
      - name: compile Shamrock
        run: |
          cd build
          ninja
  
      - name: run Shamrock Unittests world_size = 1
        run: |
          cd build
          ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 2
        run: |
          cd build
          mpirun -n 2 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
      
      - name: run Shamrock Unittests world_size = 3
        run: |
          cd build
          mpirun --oversubscribe -n 3 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 4
        run: |
          cd build
          mpirun --oversubscribe -n 4 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest


















  shamrock_acpp_cuda:
    name: AdaptiveCpp cuda clang-${{ matrix.clang }}
    runs-on: [self-hosted, ubuntu20]

    strategy:
      matrix:
        clang: [15,16]
        cuda: [11.0.2]
        rocm: [5.4.3]
    #if: false
  
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
  
      - name: ls local
        run : ls -la
  
      - name: configure Shamrock
        run: |
          python3 buildbot/configure.py --gen ninja --tests --build release \
            --builddir build --cxxpath AdaptiveCpp_comp --compiler acpp --profile cuda-sm70 \
            --cxxflags="--acpp-cuda-path=/home/docker/opt/cuda"
  
      - name: compile Shamrock
        run: |
          cd build
          ninja
  
      - name: run Shamrock Unittests world_size = 1
        run: |
          cd build
          ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 2
        run: |
          cd build
          mpirun -n 2 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
      
      - name: run Shamrock Unittests world_size = 3
        run: |
          cd build
          mpirun --oversubscribe -n 3 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 4
        run: |
          cd build
          mpirun --oversubscribe -n 4 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest



  shamrock_acpp_rocm:
    name: AdaptiveCpp rocm clang-${{ matrix.clang }}
    runs-on: [self-hosted, ubuntu20]

    strategy:
      matrix:
        clang: [15,16]
        cuda: [11.0.2]
        rocm: [5.4.3]
    #if: false
  
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
  
      - name: ls local
        run : ls -la
  
      - name: configure Shamrock
        run: |
          python3 buildbot/configure.py --gen ninja --tests --build release \
            --builddir build --cxxpath AdaptiveCpp_comp --compiler acpp --profile hip-gfx906
  
      - name: compile Shamrock
        run: |
          cd build
          ninja
  
      - name: run Shamrock Unittests world_size = 1
        run: |
          cd build
          ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 2
        run: |
          cd build
          mpirun -n 2 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
      
      - name: run Shamrock Unittests world_size = 3
        run: |
          cd build
          mpirun --oversubscribe -n 3 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 4
        run: |
          cd build
          mpirun --oversubscribe -n 4 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest

  shamrock_acpp_cuda_nvcxx:
    name: AdaptiveCpp nvcxx ${{matrix.nvhpc}}, CUDA ${{matrix.cuda}}
    runs-on: [self-hosted, ubuntu20]

    strategy:
      matrix:
        nvhpc: [22.11]
        cuda: [11.8]

    if: false
  
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
  
      - name: ls local
        run : ls -la
  
      - name: configure Shamrock
        run: |
          python3 buildbot/configure.py --gen ninja --tests --build release \
            --builddir build --cxxpath AdaptiveCpp_comp --compiler acpp --profile cuda-nvcxx
  
      - name: compile Shamrock
        run: |
          cd build
          ninja
  
      - name: run Shamrock Unittests world_size = 1
        run: |
          cd build
          ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 2
        run: |
          cd build
          mpirun -n 2 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
      
      - name: run Shamrock Unittests world_size = 3
        run: |
          cd build
          mpirun --oversubscribe -n 3 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
  
      - name: run Shamrock Unittests world_size = 4
        run: |
          cd build
          mpirun --oversubscribe -n 4 ./shamrock_test --sycl-ls-map  --sycl-cfg 0:0 --loglevel 0 --benchmark-mpi --unittest
